<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Harden Embedded Flash Controller (HEFC)" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="harden-embedded-flash-controller-hefc" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>Harden Embedded Flash Controller (HEFC)</title>
<meta name="Microsoft.Help.Id" content="GUID-1EA9B250-D935-443A-9FA9-C48E50D229E8-harden-embedded-flash-controller-hefc" />
<meta name="Microsoft.Help.TocParent" content="GUID-1EA9B250-D935-443A-9FA9-C48E50D229E8" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLABÂ® Harmony Peripheral Libraries Reference A 09/2021" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-483B2DE9-95CB-4DD4-9F85-592F15C38EFA"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="harden-embedded-flash-controller-hefc">
<h1 class="title topictitle1" id="ariaid-title1">Harden Embedded Flash Controller (HEFC)</h1><div class="body"><p class="p">The Hardened Embedded Flash Controller (HEFC) manages the programming, erasing, locking and unlocking sequences of the Flash using a full set of commands.</p>
<p class="p"><strong class="ph b">Using The Library</strong></p>
<p class="p">The main Flash memory can not be read while it is being erased or written, the CPU is stalled during the entire operation. All functions
that modify the main Flash can be run from RAM memory to avoid CPU stall while main main Flash is being erased or written.</p>
<p class="p">The FLASH memory is divided into a number of physical rows, each containing four identically sized flash pages. Pages may be read or written to
individually, however pages must be erased before being reprogrammed and the smallest granularity available for erasure is one single row.</p>
<p class="p">HEFC APIs are implemented to be non-blocking, the API will return immediately if not stalled by Flash operation. The user application can
either poll the status or get callback once the flash operation is completed.</p>
<ul class="ul"><li class="li"><p class="p">With polling, the application will need to continuously check if the flash operation is completed</p>
</li>
<li class="li"><p class="p">With callback, the registered callback function will be called once the flash operation is completed. This means the application do not have to poll continuously. The interrupt must be enabled in MHC for callback method</p>
</li>
</ul>
<p class="p">Here is an example code to erase a row and program a page of memory using polling method</p>
<pre class="pre codeblock language-c"><button title="Copy Code" class="copy-code" onclick="cpy('d734816e30', this);">Copy</button><code id="d734816e30" content="// Define a constant array in Flash.&#xA;// It must be aligned to sector boundary and size has to be in multiple of sectors&#xA;const uint8_t hefc_user_start_address[HEFC_SECTORSIZE] __attribute__((aligned(HEFC_SECTORSIZE),keep,externally_visible,space(prog)))= {0};&#xA;&#xA;void populate_buffer(uint8_t* data)&#xA;{&#xA;    int i = 0;&#xA;&#xA;    for (i = 0; i &lt; (HEFC_PAGESIZE); i++)&#xA;    {&#xA;        *(data + i) = i;&#xA;    }&#xA;}&#xA;&#xA;int main (void)&#xA;{&#xA;    uint8_t pageBuffer[HEFC_PAGESIZE] = {0};&#xA;&#xA;    /*Populate pageBuffer to programmed*/&#xA;    populate_buffer(pageBuffer);&#xA;&#xA;    while(HEFC_IsBusy());&#xA;&#xA;    /*Erase the sector*/&#xA;    HEFC_SectorErase(hefc_user_start_address);&#xA;&#xA;    /* Wait for erase operation to complete */&#xA;    while(HEFC_IsBusy());&#xA;&#xA;    /*Program a page*/&#xA;    HEFC_PageWrite(pageBuffer, hefc_user_start_address);&#xA;&#xA;    /* Wait for page program to complete&#xA;    while(HEFC_IsBusy());&#xA;}"><span class="ph token comment">// Define a constant array in Flash.</span>
<span class="ph token comment">// It must be aligned to sector boundary and size has to be in multiple of sectors</span>
<span class="ph token keyword">const</span> uint8_t hefc_user_start_address<span class="ph token punctuation">[</span>HEFC_SECTORSIZE<span class="ph token punctuation">]</span> <span class="ph token function">__attribute__</span><span class="ph token punctuation">(</span><span class="ph token punctuation">(</span><span class="ph token function">aligned</span><span class="ph token punctuation">(</span>HEFC_SECTORSIZE<span class="ph token punctuation">)</span><span class="ph token punctuation">,</span>keep<span class="ph token punctuation">,</span>externally_visible<span class="ph token punctuation">,</span><span class="ph token function">space</span><span class="ph token punctuation">(</span>prog<span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token operator">=</span> <span class="ph token punctuation">{</span><span class="ph token number">0</span><span class="ph token punctuation">}</span><span class="ph token punctuation">;</span>

<span class="ph token keyword">void</span> <span class="ph token function">populate_buffer</span><span class="ph token punctuation">(</span>uint8_t<span class="ph token operator">*</span> data<span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token keyword">int</span> i <span class="ph token operator">=</span> <span class="ph token number">0</span><span class="ph token punctuation">;</span>

    <span class="ph token keyword">for</span> <span class="ph token punctuation">(</span>i <span class="ph token operator">=</span> <span class="ph token number">0</span><span class="ph token punctuation">;</span> i <span class="ph token operator">&lt;</span> <span class="ph token punctuation">(</span>HEFC_PAGESIZE<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span> i<span class="ph token operator">++</span><span class="ph token punctuation">)</span>
    <span class="ph token punctuation">{</span>
        <span class="ph token operator">*</span><span class="ph token punctuation">(</span>data <span class="ph token operator">+</span> i<span class="ph token punctuation">)</span> <span class="ph token operator">=</span> i<span class="ph token punctuation">;</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">int</span> main <span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    uint8_t pageBuffer<span class="ph token punctuation">[</span>HEFC_PAGESIZE<span class="ph token punctuation">]</span> <span class="ph token operator">=</span> <span class="ph token punctuation">{</span><span class="ph token number">0</span><span class="ph token punctuation">}</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/*Populate pageBuffer to programmed*/</span>
    <span class="ph token function">populate_buffer</span><span class="ph token punctuation">(</span>pageBuffer<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token keyword">while</span><span class="ph token punctuation">(</span><span class="ph token function">HEFC_IsBusy</span><span class="ph token punctuation">(</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/*Erase the sector*/</span>
    <span class="ph token function">HEFC_SectorErase</span><span class="ph token punctuation">(</span>hefc_user_start_address<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Wait for erase operation to complete */</span>
    <span class="ph token keyword">while</span><span class="ph token punctuation">(</span><span class="ph token function">HEFC_IsBusy</span><span class="ph token punctuation">(</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/*Program a page*/</span>
    <span class="ph token function">HEFC_PageWrite</span><span class="ph token punctuation">(</span>pageBuffer<span class="ph token punctuation">,</span> hefc_user_start_address<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Wait for page program to complete
    while(HEFC_IsBusy());
}</span></code></pre><p class="p"><strong class="ph b">Library Interface</strong></p>
<p class="p">Harden Embedded Flash Controller peripheral library provides the following interfaces:</p>
<p class="p"><strong class="ph b">Functions</strong></p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d734816e310"><span>Name</span></th>
<th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d734816e312"><span>Description</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_Initialize</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Initializes given instance of the HEFC peripheral</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_Read</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Reads length number of bytes from a given address in FLASH memory</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_PageWrite</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Writes data of size equivalent to page size to a given FLASH address</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_SectorErase</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Erases a Sector in the FLASH</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_ErrorGet</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Returns the error encountered by HEFC controller</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_IsBusy</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Returns the current status of HEFC controller</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_RegionLock</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Locks a Flash region</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_RegionUnlock</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Unlocks a Flash region</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e310 "><span>HEFC_CallbackRegister</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e312 "><span>Sets the pointer to the function (and it's context) to be called when the operation is complete</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p"><strong class="ph b">Data types and constants</strong></p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d734816e370"><span>Name</span></th>
<th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d734816e372"><span>Type</span></th>
<th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d734816e374"><span>Description</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e370 "><span>HEFC_ERROR</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e372 "><span>Enum</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e374 "><span>Defines the data type for the HEFC Error</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e370 "><span>HEFC_CALLBACK</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e372 "><span>Typedef</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d734816e374 "><span>Defines the data type and function signature for the HEFC peripheral callback function</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</body>
</html>