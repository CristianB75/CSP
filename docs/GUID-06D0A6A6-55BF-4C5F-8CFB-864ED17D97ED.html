<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=EmulateIE11" /><meta name="copyright" content="(C) Copyright 2022" />
<meta name="DC.rights.owner" content="(C) Copyright 2022" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Non-Volatile Memory (NVM)" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="non-volatile-memory-nvm" />
<link rel="stylesheet" type="text/css" href="stylesheets/commonltr.css" />
<link rel="stylesheet" type="text/css" href="stylesheets/atmel.css" />
<link rel="stylesheet" type="text/css" href="./stylesheets/common-extended.css" /><title>Non-Volatile Memory (NVM)</title>
<meta name="Microsoft.Help.Id" content="GUID-1EA9B250-D935-443A-9FA9-C48E50D229E8-non-volatile-memory-nvm" />
<meta name="Microsoft.Help.TocParent" content="GUID-1EA9B250-D935-443A-9FA9-C48E50D229E8" />
<meta name="Microsoft.Help.TocOrder" content="0" />
<meta name="Microsoft.Help.Locale" content="en-US" />
<meta name="Microsoft.Help.TopicLocale" content="en-US" />
<meta name="Microsoft.Help.DisplayVersion" content="MPLABÂ® Harmony Peripheral Libraries Reference A 09/2021" />
<script language="javascript">
       
       if (window.parent.location.protocol != 'file:') {
				document.addEventListener('click', function(e) {
				    if (e.target) {
               if (e.target.nodeName == "A" ) {
                    if (!e.target.target) {
                      e.preventDefault();
                      e.stopPropagation();
                              
                      var origUrl = window.parent.location.href.substr(0, window.parent.location.href.indexOf("?"));
                      if (origUrl.length === 0) {
                          origUrl = window.parent.location.href;
                      }
                      var href= e.target.getAttribute("href");
                      var parts = href.split("#");
          
                      var url = "";
                      if (parts.length == 2 ) {
                        if (!parts[0].length) {
                            url = window.parent.location.search.replace('?','')
                        } else {
                            url = parts[0].replace('.html','');
                        }
                      } else {
                        url = parts[0].replace('.html','');
                      }

                      if (parts.length == 2) {
                          url += "#" + parts[1];
                      }
    
                      window.parent.location.href = origUrl + "?" + url;

                      return false;
                    }
               }
            }
				});
			}

		</script><script language="javascript">
        function cpy(id, button) {
        
            var element = document.getElementById(id);
            var content = element.getAttribute("content");
            var textArea = document.createElement("textarea");
            
            // Place in the top-left corner of screen regardless of scroll position.
            textArea.style.position = 'fixed';
            textArea.style.top = 0;
            textArea.style.left = 0;
            
            // Ensure it has a small width and height. Setting to 1px / 1em
            // doesn't work as this gives a negative w/h on some browsers.
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            
            // We don't need padding, reducing the size if it does flash render.
            textArea.style.padding = 0;
            
            // Clean up any borders.
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            
            // Avoid flash of the white box if rendered for any reason.
            textArea.style.background = 'transparent';
            
            
            textArea.value = content;
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
               var successful = document.execCommand('copy');
               var msg = successful ? 'successful' : 'unsuccessful';
               if (!button.classList.contains("copied")){
                  button.textContent = "Copied";
                  button.classList.add("copied");
                  setTimeout(function(){
                    button.textContent = "Copy";
                    button.classList.remove("copied");
                  },1000);
               }
            } catch (err) {
              console.log('Oops, unable to copy');
            }
            
            document.body.removeChild(textArea);
        }
      </script><script language="javascript">
          
          // Add the MathML namespace to html
          var html = document.getElementsByTagName("html")[0],
          head = document.getElementsByTagName("head")[0];
          
          var mathJax = document.createElement("script");
          mathJax.src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML";
          head.appendChild(mathJax);
          
          html.setAttribute("xmlns:m","http://www.w3.org/1998/Math/MathML");
          
          function inIframe() { try { return window.self !== window.top; } catch (e) { return true; } }
          
          if (!inIframe()) { 
          
          var Default = "index.html?GUID-06D0A6A6-55BF-4C5F-8CFB-864ED17D97ED"; 
          
          var displaylocation = "value" + window.location.href;
          
          var GUIDS = displaylocation.split('GUID');          
          
          if (displaylocation.indexOf('#GUID') != -1) {            
          var First = GUIDS[1].split('.html');  
          if (GUIDS[3]){First = GUIDS[2].split('.html');}
          if (GUIDS[4]){First = GUIDS[3].split('.html');}
          if (GUIDS[5]){First = GUIDS[4].split('.html');}
          
          var Second = GUIDS[2].split('#');   
          if (GUIDS[3]){Second = GUIDS[3].split('#');}
          if (GUIDS[4]){Second = GUIDS[4].split('#');}
          if (GUIDS[5]){Second = GUIDS[5].split('#');}
          
          Default = "index.html?" + "GUID" + First[0] + "GUID" + Second[0];     
          }                    
          window.top.location = Default;
          }       
          
        </script><style xml:space="">
        
          button.copy-code{
            display:none;
            padding:0.7em 1.4em;
            margin:0 0.3em 0.3em 0;
            border-radius:0.15em;
            box-sizing: border-box;
            text-decoration:none;
            font-family:'Roboto',sans-serif;
            text-transform:uppercase;
            font-weight:400;
            color:#FFFFFF;
            background-color:#9c9c9c;
            box-shadow:inset 0 -0.6em 0 -0.35em rgba(0,0,0,0.17);
            text-align:center;
            position:relative;
            border: 0;
            float: right;
            border-radius: .5em;
            cursor: pointer;
          }
          button.copy-code:active{
            top:0.1em;
          }
          
          pre:hover button.copy-code{
            display: inline-block !important;
          }
          button.copy-code.copied {
            cursor: default !important;
          }
          
          
          @media all and (max-width:30em){
            button.copy-code{
              display:block;
              margin:0.4em auto;
            }
          }
        
        
      </style></head>
<body id="non-volatile-memory-nvm">
<h1 class="title topictitle1" id="ariaid-title1">Non-Volatile Memory (NVM)</h1><div class="body"><p class="p">The Non-Volatile Memory (NVM) module provides an interface to the device's Non-Volatile Memory controller, so that memory pages can be written, read, erased, and reconfigured in a standardized manner.</p>
<p class="p"><strong class="ph b">Using The Library</strong></p>
<p class="p">The main Flash memory can not be read while it is being erased or written, the CPU is stalled during the entire operation. All functions that modify the main Flash can be run from RAM memory to avoid CPU stall while main main Flash is being erased or written.</p>
<p class="p">The Program flash memory is divided into two Virtual regions pointing to the same physical memory location. Client can use any address from these virtual regions to perform erase/write/read operation</p>
<ul class="ul"><li class="li"><p class="p">KSEG0 is cacheable region</p>
</li>
<li class="li"><p class="p">KSEG1 is non-cacheable region</p>
</li>
</ul>
<p class="p">The program Flash array is built up of a series of rows to form a page. A page of Flash is the smallest unit of memory that can be erased at a single time. The program Flash array can be programmed in one of two ways:</p>
<ul class="ul"><li class="li"><p class="p">Row programming, with 128 instruction words at a time</p>
</li>
<li class="li"><p class="p">Word programming, with 1 instruction word at a time</p>
</li>
</ul>
<p class="p">NVM APIs are implemented to be non-blocking, the API will return immediately unless stalled by Flash operation. The user application can either use polling or callback method to indicate the transfer status.</p>
<ul class="ul"><li class="li"><p class="p">With polling, the application will need to continuously check if the flash operation is completed.</p>
</li>
<li class="li"><p class="p">With callback, the registered callback function will be called once the flash operation is completed. This means the application do not have to poll continuously.</p>
</li>
</ul>
<p class="p">Here is an example code to erase a page and program a row of memory using polling method</p>
<pre class="pre codeblock language-c"><button title="Copy Code" class="copy-code" onclick="cpy('d711921e46', this);">Copy</button><code id="d711921e46" content="#define APP_FLASH_ADDRESS  (NVM_FLASH_START_ADDRESS + (NVM_FLASH_SIZE / 2))&#xA;&#xA;uint8_t CACHE_ALIGN rowBuffer[NVM_FLASH_ROWSIZE] = {0};&#xA;&#xA;void populate_buffer(uint8_t* data)&#xA;{&#xA;    int i = 0;&#xA;&#xA;    for (i = 0; i &lt; (NVM_FLASH_ROWSIZE); i++)&#xA;    {&#xA;        *(data + i) = i;&#xA;    }&#xA;}&#xA;&#xA;int main (void)&#xA;{&#xA;    /*Populate rowBuffer to programmed*/&#xA;    populate_buffer(rowBuffer);&#xA;&#xA;    while(NVM_IsBusy());&#xA;&#xA;    /* Erase the page */&#xA;    NVM_PageErase(APP_FLASH_ADDRESS);&#xA;&#xA;    /* Wait for page erase  to complete */&#xA;    while(NVM_IsBusy());&#xA;&#xA;    /* Program a row of data */&#xA;    NVM_RowWrite((uint32_t *)rowBuffer, APP_FLASH_ADDRESS);&#xA;&#xA;    /* Wait for row program to compete */&#xA;    while(NVM_IsBusy());&#xA;}&#xA;"><span class="ph token macro property">#<span class="ph token directive keyword">define</span> APP_FLASH_ADDRESS  (NVM_FLASH_START_ADDRESS + (NVM_FLASH_SIZE / 2))</span>

uint8_t CACHE_ALIGN rowBuffer<span class="ph token punctuation">[</span>NVM_FLASH_ROWSIZE<span class="ph token punctuation">]</span> <span class="ph token operator">=</span> <span class="ph token punctuation">{</span><span class="ph token number">0</span><span class="ph token punctuation">}</span><span class="ph token punctuation">;</span>

<span class="ph token keyword">void</span> <span class="ph token function">populate_buffer</span><span class="ph token punctuation">(</span>uint8_t<span class="ph token operator">*</span> data<span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token keyword">int</span> i <span class="ph token operator">=</span> <span class="ph token number">0</span><span class="ph token punctuation">;</span>

    <span class="ph token keyword">for</span> <span class="ph token punctuation">(</span>i <span class="ph token operator">=</span> <span class="ph token number">0</span><span class="ph token punctuation">;</span> i <span class="ph token operator">&lt;</span> <span class="ph token punctuation">(</span>NVM_FLASH_ROWSIZE<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span> i<span class="ph token operator">++</span><span class="ph token punctuation">)</span>
    <span class="ph token punctuation">{</span>
        <span class="ph token operator">*</span><span class="ph token punctuation">(</span>data <span class="ph token operator">+</span> i<span class="ph token punctuation">)</span> <span class="ph token operator">=</span> i<span class="ph token punctuation">;</span>
    <span class="ph token punctuation">}</span>
<span class="ph token punctuation">}</span>

<span class="ph token keyword">int</span> main <span class="ph token punctuation">(</span><span class="ph token keyword">void</span><span class="ph token punctuation">)</span>
<span class="ph token punctuation">{</span>
    <span class="ph token comment">/*Populate rowBuffer to programmed*/</span>
    <span class="ph token function">populate_buffer</span><span class="ph token punctuation">(</span>rowBuffer<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token keyword">while</span><span class="ph token punctuation">(</span><span class="ph token function">NVM_IsBusy</span><span class="ph token punctuation">(</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Erase the page */</span>
    <span class="ph token function">NVM_PageErase</span><span class="ph token punctuation">(</span>APP_FLASH_ADDRESS<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Wait for page erase  to complete */</span>
    <span class="ph token keyword">while</span><span class="ph token punctuation">(</span><span class="ph token function">NVM_IsBusy</span><span class="ph token punctuation">(</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Program a row of data */</span>
    <span class="ph token function">NVM_RowWrite</span><span class="ph token punctuation">(</span><span class="ph token punctuation">(</span>uint32_t <span class="ph token operator">*</span><span class="ph token punctuation">)</span>rowBuffer<span class="ph token punctuation">,</span> APP_FLASH_ADDRESS<span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>

    <span class="ph token comment">/* Wait for row program to compete */</span>
    <span class="ph token keyword">while</span><span class="ph token punctuation">(</span><span class="ph token function">NVM_IsBusy</span><span class="ph token punctuation">(</span><span class="ph token punctuation">)</span><span class="ph token punctuation">)</span><span class="ph token punctuation">;</span>
<span class="ph token punctuation">}</span>
</code></pre><p class="p"><strong class="ph b">Library Interface</strong></p>
<p class="p">Peripheral library provides the following interfaces:</p>
<p class="p"><strong class="ph b">Functions</strong></p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d711921e297"><span>Name</span></th>
<th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d711921e299"><span>Description</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_Initialize</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Initializes given instance of the NVM peripheral</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_Read</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Reads length number of bytes from a given address in FLASH memory</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_RowWrite</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Writes one row of data to given NVM address</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_WordWrite</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Writes One word into the Flash</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_PageErase</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Erases a Page in the NVM</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_ErrorGet</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Returns the error state of NVM controller</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_IsBusy</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Returns the current status of NVM controller</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e297 "><span>NVM_CallbackRegister</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e299 "><span>Sets the pointer to the function (and it's context) to be called when the operation is complete</span></td>
</tr>
</tbody>
</table>
</div>
<p class="p"><strong class="ph b">Data types and constants</strong></p>

<div class="tablenoborder"><table cellpadding="4" cellspacing="0" summary="" class="table" frame="border" border="1" rules="all"><col style="width:" /><col style="width:" /><col style="width:" /><thead class="thead" style="text-align:left;"><tr class="row"><th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d711921e352"><span>Name</span></th>
<th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d711921e354"><span>Type</span></th>
<th class="entry cellrowborder" style="text-align:left;vertical-align:middle;" id="d711921e356"><span>Description</span></th>
</tr>
</thead>
<tbody class="tbody"><tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e352 "><span>NVM_ERROR</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e354 "><span>Enum</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e356 "><span>Defines the NVM Error Type</span></td>
</tr>
<tr class="row"><td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e352 "><span>NVM_CALLBACK</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e354 "><span>Typedef</span></td>
<td class="entry cellrowborder" style="text-align:left;vertical-align:middle;" headers="d711921e356 "><span>Defines the data type and function signature for the NVM peripheral callback function</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</body>
</html>