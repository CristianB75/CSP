# Hardened External Memory Controller \(HEMC\)

The HEMC System Memory interface provides a simple interface to manage<br />the externally connected SDRAM, PROM and SRAM device.

**Using The Library**

The HEMC controller is initialized as configured in the MHC as part of<br />System Initialization.

If interrupts are used, the callback function should be set for<br />expected interrupts types:

```c
    /* Register Fixable errors Callback */
    HEMC_FixCallbackRegister(HEMC_FixCallback_Function, (uintptr_t)NULL);
    /* Register UnFixable errors Callback */
    HEMC_NoFixCallbackRegister(HEMC_NoFixCallback_Function, (uintptr_t)NULL);
```

When an ECC error is detected and an interrupt occurs, the fail address<br />must be read before the status in order to avoid multiple interrupts:

```c
    /* Read the fault address before clearing the interrupt*/
    uint32_t* fault_pointer = (uint32_t*)HEMC_HeccGetFailAddress();

    /* Only for Fixable error handler : Read corrected data on the Fly */
    uint32_t fault_data = *fault_pointer;

    /* Read HEMC HECC Status */
    HEMC_HECC_STATUS value = HEMC_HeccGetStatus();
```

The faulty address may then be fixed by the application if applicable.

**Error injection test mode**

**ECC Check bit read**

The ECC check bit value can be get when the read test mode is<br />activated. Once this mode is activated, the check bit value for each<br />read of data on HSMC or HSDRAMC memories is stored in corresponding<br />registers. It is possible to get the last check bit value using the<br />\\function HEMC\_TestModeGetCbValue.

```c
    /* Enable HEMC HECC Test mode Read in HSDRAMC memory */
    HEMC_TestModeReadEnable(HEMC_HEMC_CH_HSDRAMC);
    __DSB();
    __ISB();

    /* Read data in external memory */
    data = buffer;
    __DSB();
    __ISB();

    /* Get the Check Bit for last data read in HSDRAMC memory */
    tcb = HEMC_TestModeGetCbValue(HEMC_HEMC_CH_HSDRAMC);
    __DSB();
    __ISB();

    /* Disable HEMC HECC Test mode Read in HSDRAMC memory */
    HEMC_TestModeReadDisable(HEMC_HEMC_CH_HSDRAMC);
```

*Note*: It is recommended to use memory barriers on Cortex-M<br />core-based products where instructions can be executed out of<br />programmed order, or to ensure that all memory transfers or<br />instructions are completed before any new instruction is executed. In<br />our application, we must ensure that register modification and memory<br />transfers are completed before executing the next step.

**ECC Check bit write**

The ECC check bit value can be override when the write test mode is<br />activated. Once this mode is activated, the check bit value for each<br />write of data on HSMC or HSDRAMC memories is override by the given<br />value instead of being calculated automatically. The check bit value<br />used should be set using the function HEMC\_TestModeSetCbValue.

```c
    /* Enable HEMC HECC Test mode Write in HSDRAMC memory */
    HEMC_TestModeWriteEnable(HEMC_HEMC_CH_HSDRAMC);
    __DSB();
    __ISB();

    /* Set the Check Bit for override when data will be write in external HSDRAMC memory */
    HEMC_TestModeSetCbValue(HEMC_HEMC_CH_HSDRAMC, tcb);
    __DSB();
    __ISB();

    /* Write data in external memory */
    buffer = data;
    __DSB();
    __ISB();

    /* Disable HEMC HECC Test mode Write in HSDRAMC memory */
    HEMC_TestModeWriteDisable(HEMC_HEMC_CH_HSDRAMC);
```

*Note*: It is recommended to use memory barriers on Cortex-M<br />core-based products where instructions can be executed out of<br />programmed order, or to ensure that all memory transfers or<br />instructions are completed before any new instruction is executed. In<br />our application, we must ensure that register modification and memory<br />transfers are completed before executing the next step.

**Library Interface**

HEMC peripheral library provides the following interfaces:

**Functions**

|Name|Description|
|----|-----------|
|HEMC\_Initialize|Initializes and Enables the HSDRAM and HSMC Controller|
|HEMC\_HeccGetStatus|Get the HECC status of the HEMC peripheral|
|HEMC\_HeccGetFailAddress|Get the last fail address were ECC error occurs in a HEMC memory|
|HEMC\_HeccResetCounters|Reset Fix and NoFix error counters of the HEMC peripheral|
|HEMC\_FixCallbackRegister|Sets the pointer to the function \(and it's context\) to be called when the given HEMC's ECC Fixable Error interrupt events occur|
|HEMC\_NoFixCallbackRegister|Sets the pointer to the function \(and it's context\) to be called when the given HEMC's ECC Not Fixable Error interrupt events occur|
|HEMC\_TestModeReadEnable|Enable the HEMC peripheral HECC test mode Read|
|HEMC\_TestModeReadDisable|Disable the HEMC peripheral HECC test mode Read|
|HEMC\_TestModeWriteEnable|Enable the HEMC peripheral HECC test mode Write|
|HEMC\_TestModeWriteDisable|Disable the HEMC peripheral HECC test mode Write|
|HEMC\_TestModeGetCbValue|Get the HEMC peripheral HECC test mode check bit values|
|HEMC\_TestModeSetCbValue|Set the HEMC peripheral HECC test mode check bit values|

**Data types and constants**

|Name|Type|Description|
|----|----|-----------|
|HEMC\_HEMC\_CHANNEL|Enum|Identifies the HEMC HECC channel|
|HEMC\_HECC\_STATUS|Enum|Identifies the HEMC HECC current status|
|HEMC\_CALLBACK|Typedef|HEMC Callback Function Pointer|

-   **[HEMC\_Initialize Function](GUID-5C0523D1-DFD0-40D6-BD87-1518448FA645.md)**  

-   **[HEMC\_HeccGetStatus Function](GUID-E3FFFA9B-68F1-4923-A052-0EA33D3ECC02.md)**  

-   **[HEMC\_HeccGetFailAddress Function](GUID-E924C153-A773-4B39-8BBF-657E50E4830D.md)**  

-   **[HEMC\_HeccResetCounters Function](GUID-09D2A71E-72E9-455D-828C-C77882C26A1F.md)**  

-   **[HEMC\_FixCallbackRegister Function](GUID-BF5C1C51-8680-45EC-8B4B-9EAB0509C097.md)**  

-   **[HEMC\_NoFixCallbackRegister Function](GUID-37905422-0400-4533-B29E-6CDCD42CEB78.md)**  

-   **[HEMC\_TestModeReadEnable Function](GUID-CEC7A86D-8258-413D-8665-065BB04B9A7A.md)**  

-   **[HEMC\_TestModeReadDisable Function](GUID-584FFA45-67A7-4FC7-932B-524836D8B4BC.md)**  

-   **[HEMC\_TestModeWriteEnable Function](GUID-560B688E-793C-4426-8681-4A8DC10707C8.md)**  

-   **[HEMC\_TestModeWriteDisable Function](GUID-11A78562-F5EB-4F5C-8A6E-541A1F0D6F00.md)**  

-   **[HEMC\_TestModeGetCbValue Function](GUID-FD246AFF-76D2-4850-A91B-281A8A9BE14D.md)**  

-   **[HEMC\_TestModeSetCbValue Function](GUID-17C26BF5-106B-4E94-8801-37F094860CB8.md)**  

-   **[HEMC\_HEMC\_CHANNEL Enum](GUID-8E454F22-C02E-4F25-BA12-EDFD6B6199F2.md)**  

-   **[HEMC\_HECC\_STATUS Enum](GUID-15C7FA7B-B2BA-46A3-920C-00BE61332CF3.md)**  

-   **[HEMC\_CALLBACK Typedef](GUID-A77CA40E-3BD0-42E8-8E15-1F434B29D7AC.md)**  


**Parent topic:**[SAM RH707 Peripheral Libraries](GUID-C2AC236D-363B-4378-A381-B281F67C8647.md)

**Parent topic:**[SAM RH71 Peripheral Libraries](GUID-AC9BE324-E486-46EA-8D16-E04E15288053.md)

