# L2 Cache Controller \(L2CC\)

The L2 Cache Controller \(L2CC\) is based on the L2CC-PL310 ARM multiway cache macrocell, version r3p2. The addition of an on-chip secondary cache, also referred to as a Level 2 or L2 cache, is a method of improving the system performance when significant memory traffic is generated by the processor.

**Using The Library**

The interface to L2 Cache operations is defined in the plib\_l2cc.h header file. By definition a secondary cache assumes<br />the presence of a Level 1 or primary cache, closely coupled or internal to the processor. Memory access is fastest to L1 cache, followed closely by L2 cache.

**Cache Coherency**

Cache coherency is the discipline of ensuring that the data stored in main memory matches the corresponding data in the cache. The majority of the cache-related APIs deal with cache coherency. These functions allow the user to flush, clean and invalidate entire cache\(s\), or just a range of addresses within the cache.

Caches most often lose coherency when a bus master other than the CPU modifies memory. This happens frequently with DMA. Two examples are provided in the following section.

**Example 1**

Imagine a situation where you would like to transfer data from a source buffer to a destination buffer using DMA. You would write data to the source buffer, start the DMA transfer, and then expect that the same data now appears in the destination buffer. With the cache in write-back mode, this will not be the case. When transferring data out of memory using DMA, it is possible that the desired data is held in the cache, but has never been written back to main memory. Therefore, in this case, you write data to the source buffer and it gets stored in cache. When the DMA transfer executes, it will pull the data from the source buffer out of RAM and then transfer it to the destination buffer in RAM. The problem is that the fresh data was stored in the cache but never written back to RAM, so what has happened is that stale data was copied over rather than the intended data. What is needed is a way to force the cache to write its data back to main memory before the DMA transfer. This is known as a write-back operation and would be performed with the use of the function: DCACHE\_CLEAN\_BY\_ADDR\(addr,sz\). This cleans L1 and L2 caches by invoking dcache\_CleanByAddr\(addr,sz\) and PLIB\_L2CC\_CleanCacheByAddr\(addr,sz\) functions.

**Example 2**

The second situation involves writing data into memory using DMA. Imagine that the cache is holding a chunk of data known as destination\_buffer. You then execute a DMA transfer to copy some new data from a source buffer into destination\_buffer. The issue here is that main memory now contains the correct data, but the cache holds a copy of stale data for destination\_buffer. The CPU cannot see this problem and it will keep pulling the data out of the cache, not even realizing that itâ€™s stale. What is needed is a way to tell the cache to pull the fresh data out of main memory, to replace the stale data that the cache contains. This is known as an invalidate operation. It is performed with the use of the function: DCACHE\_INVALIDATE\_BY\_ADDR\(addr,sz\). This invalidates L1 and L2 caches by invoking PLIB\_L2CC\_InvalidateCacheByAddr\(addr,sz\) and dcache\_InvalidateByAddr\(addr,sz\) functions.

The example application, cache\_maintenance, in the Cache PLIB Examples demonstrates this situation and shows how to resolve the issue.

**Library Interface**

L2 Cache Controller peripheral library provides the following interfaces:

**Functions**

|Name|Description|
|----|-----------|
|PLIB\_L2CC\_Initialize|Initialize the L2 cache controller|
|PLIB\_L2CC\_CleanCache|Cleans \(flushes\) the L2 cache|
|PLIB\_L2CC\_InvalidateCache|Invalidates L2 cache entries|
|PLIB\_L2CC\_CleanInvalidateCache|Cleans and Invalidates L2 cache entries|
|PLIB\_L2CC\_InvalidateCacheByAddr|Invalidates L2 cache entries|
|PLIB\_L2CC\_CleanCacheByAddr|Flushes L2 cache entries|
|PLIB\_L2CC\_CleanInvalidateCacheByAddr|Cleans and Invalidates L2 cache entries|

-   **[PLIB\_L2CC\_Initialize Function](GUID-406315A0-F9CB-4F1E-9B2F-6F5300F7EA7E.md)**  

-   **[PLIB\_L2CC\_CleanCache Function](GUID-17FD1D6A-336B-46CF-8327-DB62884EEC3E.md)**  

-   **[PLIB\_L2CC\_CleanCacheByAddr Function](GUID-E02F5D09-4751-4E33-AD5B-EAC8E36217F0.md)**  

-   **[PLIB\_L2CC\_CleanInvalidateCache Function](GUID-8EDB7125-758E-4FA1-B405-8743FF0CE37D.md)**  

-   **[PLIB\_L2CC\_CleanInvalidateCacheByAddr Function](GUID-4D2FF96D-A4C0-4526-8FCF-5C9E2401E62A.md)**  

-   **[PLIB\_L2CC\_InvalidateCache Function](GUID-C475AFE4-0F93-4F8B-B11F-DCFEB112E4CC.md)**  

-   **[PLIB\_L2CC\_InvalidateCacheByAddr Function](GUID-1A8B27D0-D3F1-4ED5-8021-4329AA742F68.md)**  


**Parent topic:**[SAM A5D2 Peripheral Libraries](GUID-F6605EDC-FC71-4081-8560-0C1681C1FA8D.md)

